// Prisma schema for Grievance Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OFFICER
  PUBLIC
  MINISTER
  PA
  FIELD_OFFICER
  BACK_OFFICER
}

enum GrievanceStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  UNDER_REVIEW
  RESOLVED
  CLOSED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(PUBLIC)
  phone        String?  @db.VarChar(32)
  status       String?  @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignedGrievances Grievance[] @relation("AssignedToUser")
  statusUpdates     GrievanceStatusUpdate[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  governmentProjects GovernmentProject[]
  patientGrievances PatientGrievance[]
  individualGrievances IndividualGrievance[]
  jobRequests       JobRequest[]
  ttdRequests       TTDRequest[]
  assignedProjects  GovernmentProject[] @relation("ProjectAssignedTo")
  assignedPatients  PatientGrievance[] @relation("PatientAssignedTo")
  assignedIndividuals IndividualGrievance[] @relation("IndividualAssignedTo")
  assignedJobs      JobRequest[] @relation("JobAssignedTo")
  assignedTTDs      TTDRequest[] @relation("TTDAssignedTo")
}

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  color       String? // optional UI color
  description String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  grievances Grievance[]
}

model Grievance {
  id                String          @id @default(cuid())
  referenceNumber   String          @unique @default("TEMP-GRV-0000") // Format: GRV-YYYY-XXXX
  title             String
  description       String
  status            GrievanceStatus @default(PENDING)
  priority          Priority        @default(MEDIUM)
  
  // Requester Information
  requesterName     String          @default("Unknown Requester")
  requesterPhone    String          @db.VarChar(32) @default("+910000000000")
  requesterEmail    String?
  requesterAddress  String?
  
  // Location Information
  village           String?
  mandal            String?
  district          String?
  state             String?         @default("Telangana")
  pincode           String?
  latitude          Float?
  longitude         Float?
  
  // Additional Details
  estimatedCost     Float?
  expectedResolutionDate DateTime?
  actualResolutionDate   DateTime?
  remarks           String?
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  category          Category?       @relation(fields: [categoryId], references: [id])
  categoryId        String?
  
  assignedTo        User?           @relation("AssignedToUser", fields: [assignedToId], references: [id])
  assignedToId      String?
  
  attachments       Attachment[]
  statusUpdates     GrievanceStatusUpdate[]
}

model Attachment {
  id          String    @id @default(cuid())
  fileName    String
  originalName String
  url         String
  mimeType    String
  fileSize    Int       // Size in bytes
  grievance   Grievance @relation(fields: [grievanceId], references: [id], onDelete: Cascade)
  grievanceId String
  uploadedBy  String?
  createdAt   DateTime  @default(now())
}

model GrievanceStatusUpdate {
  id          String          @id @default(cuid())
  grievance   Grievance       @relation(fields: [grievanceId], references: [id], onDelete: Cascade)
  grievanceId String
  user        User            @relation(fields: [userId], references: [id])
  userId      String
  oldStatus   GrievanceStatus?
  newStatus   GrievanceStatus
  remarks     String?
  createdAt   DateTime        @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // CREATE, UPDATE, DELETE, STATUS_CHANGE, ASSIGNMENT
  entityType  String   // GRIEVANCE, USER, CATEGORY, etc.
  entityId    String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  oldValues   Json?    // Previous state
  newValues   Json?    // New state
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

model Notification {
  id          String    @id @default(cuid())
  type        String    // GRIEVANCE_CREATED, STATUS_CHANGED, etc.
  title       String
  message     String
  isRead      Boolean   @default(false)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  data        Json?     // Additional context data
  createdAt   DateTime  @default(now())
}

enum ProjectStatus {
  COMPLETED
  IN_PROGRESS
  YET_TO_COMPLETE
}

model GovernmentProject {
  id              String        @id @default(cuid())
  referenceNumber String        @unique @default("TEMP-PRJ-0000")
  projectName     String
  description     String?
  ministerName    String
  status          ProjectStatus
  estimatedCost   Float?
  actualCost      Float?
  startDate       DateTime?
  completionDate  DateTime?
  village         String?
  mandal          String?
  district        String?
  state           String        @default("Telangana")
  beneficiaries   Int?
  remarks         String?
  attachments     Json?         // Array of file URLs
  assignedToId    String?
  assignedTo      User?         @relation("ProjectAssignedTo", fields: [assignedToId], references: [id])
  createdBy       String
  createdByUser   User          @relation(fields: [createdBy], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum GrievanceType {
  PATIENT_ISSUE
  INDIVIDUAL_ISSUE
  JOB_REQUEST
  TTD_REQUEST
  OTHER
}

model PatientGrievance {
  id                    String   @id @default(cuid())
  referenceNumber       String   @unique @default("TEMP-PAT-0000")
  patientName           String
  patientPhone          String
  village               String?
  caretakerName         String?
  caretakerPhone        String?
  issue                 String
  hospital              String?
  doctor                String?
  referredByName        String?
  referredByNumber      String?
  status                String   @default("NEW")
  assignedToId          String?
  assignedTo            User?    @relation("PatientAssignedTo", fields: [assignedToId], references: [id])
  qrCode                String?  // QR code data
  createdBy             String
  createdByUser         User     @relation(fields: [createdBy], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model IndividualGrievance {
  id                String   @id @default(cuid())
  name              String
  mobileNumber      String
  village           String?
  contactName       String?
  contactNumber     String?
  office            String?
  subject           String
  referredByName    String?
  referredByNumber  String?
  assignedToId      String?
  assignedTo        User?    @relation("IndividualAssignedTo", fields: [assignedToId], references: [id])
  createdBy         String
  createdByUser     User     @relation(fields: [createdBy], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model JobRequest {
  id                String   @id @default(cuid())
  name              String
  mobileNumber      String
  village           String?
  contactName       String?
  contactNumber     String?
  office            String?
  subject           String
  referredByName    String?
  referredByNumber  String?
  assignedToId      String?
  assignedTo        User?    @relation("JobAssignedTo", fields: [assignedToId], references: [id])
  createdBy         String
  createdByUser     User     @relation(fields: [createdBy], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model TTDRequest {
  id                    String      @id @default(cuid())
  darshanDate           DateTime
  darshanType           String
  accommodationFrom     DateTime?
  accommodationTo       DateTime?
  guests                Json        // Array of guest details
  referenceName         String?
  referenceNumber       String?
  referenceVillage      String?
  referenceMandal       String?
  assignedToId          String?
  assignedTo            User?       @relation("TTDAssignedTo", fields: [assignedToId], references: [id])
  createdBy             String
  createdByUser         User        @relation(fields: [createdBy], references: [id])
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

